name: Enhancer Service Deployment

on:
  repository_dispatch:
    types: [deploy-enhancer-service]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Docker image tag'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Enhancer Service
    runs-on: ubuntu-latest
    environment: ${{ github.event.client_payload.environment || inputs.environment }}
    
    steps:
      - name: Checkout DevOps repo
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "IMAGE_TAG=${{ github.event.client_payload.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ github.event.client_payload.environment }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ inputs.environment }}" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Prepare task definition
        run: |
          cp services/enhancer-service/ecs/task-definition-template.json task-def.json
          
          # Replace placeholders
          sed -i "s/{{ENVIRONMENT}}/${{ env.ENV_NAME }}/g" task-def.json
          sed -i "s|{{IMAGE_TAG}}|$IMAGE_TAG|g" task-def.json
          sed -i "s/{{AWS_ACCOUNT_ID}}/${{ secrets.AWS_ACCOUNT_ID }}/g" task-def.json
          sed -i "s/{{AWS_REGION}}/${{ secrets.AWS_REGION }}/g" task-def.json
          
          # Inject environment variables from config
          CONFIG_FILE="services/enhancer-service/config/${{ env.ENV_NAME }}.json"
          CONFIG_ENV=$(jq -r '.envVars | to_entries | map({name: .key, value: .value})' $CONFIG_FILE)
          jq --argjson env "$CONFIG_ENV" '.containerDefinitions[0].environment = $env' task-def.json > task-def-updated.json
          mv task-def-updated.json task-def.json
      
      - name: Deploy to ECS
        run: |
          echo "üöÄ Deploying to ECS Cluster: btg-${{ env.ENV_NAME }}-cluster"
          echo "Service: btg-${{ env.ENV_NAME }}-enhancer-service"
          echo "Image: ghcr.io/btg-c/btg-enhancer-service:$IMAGE_TAG"
          
          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
            
          echo "‚úÖ Registered Task Definition: $NEW_TASK_DEF_ARN"
          
          # Update Service
          aws ecs update-service \
            --cluster btg-${{ env.ENV_NAME }}-cluster \
            --service btg-${{ env.ENV_NAME }}-enhancer-service \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment
            
          echo "‚è≥ Waiting for deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster btg-${{ env.ENV_NAME }}-cluster \
            --services btg-${{ env.ENV_NAME }}-enhancer-service
            
          echo "‚úÖ Deployment Complete!"

# ==============================================================================
# MFE Promotion Pipeline - Deploy from GHCR to AWS
# ==============================================================================
# Runs in: btg-devops repository
# Triggered by: repository_dispatch from app repos OR manual workflow_dispatch
# Purpose: Pull artifact from GHCR â†’ Deploy to S3 â†’ Invalidate CloudFront
# ==============================================================================

name: MFE Promotion Pipeline

on:
  repository_dispatch:
    types: [deploy-mfe]
  workflow_dispatch:
    inputs:
      app_name:
        description: 'Application to deploy'
        required: true
        type: choice
        options:
          - shell
          - enhancer
      build_version:
        description: 'Build version (e.g., abc1234-20260113-143020)'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read
  packages: read

env:
  REGISTRY: ghcr.io

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.environment || inputs.environment }}
    
    steps:
      # ========================================================================
      # Setup
      # ========================================================================
      - name: Set variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            APP_NAME="${{ github.event.client_payload.app_name }}"
            BUILD_VERSION="${{ github.event.client_payload.build_version }}"
            ENVIRONMENT="${{ github.event.client_payload.environment }}"
            SOURCE="${{ github.event.client_payload.source_repo }}"
          else
            APP_NAME="${{ inputs.app_name }}"
            BUILD_VERSION="${{ inputs.build_version }}"
            ENVIRONMENT="${{ inputs.environment }}"
            SOURCE="manual-trigger"
          fi
          
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "build_version=${BUILD_VERSION}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "source=${SOURCE}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Deployment Info:"
          echo "  App: ${APP_NAME}"
          echo "  Version: ${BUILD_VERSION}"
          echo "  Environment: ${ENVIRONMENT}"
          echo "  Source: ${SOURCE}"
      
      # ========================================================================
      # Pull Artifact from GHCR
      # ========================================================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull artifact
        id: pull
        env:
          APP_NAME: ${{ steps.vars.outputs.app_name }}
          BUILD_VERSION: ${{ steps.vars.outputs.build_version }}
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ github.repository_owner }}/btg-${APP_NAME}-mfe:${BUILD_VERSION}"
          echo "ðŸ“¥ Pulling: ${IMAGE_NAME}"
          
          if ! docker pull ${IMAGE_NAME}; then
            echo "âŒ Failed to pull artifact from GHCR"
            exit 1
          fi
          
          # Extract artifact
          CONTAINER_ID=$(docker create ${IMAGE_NAME})
          docker cp ${CONTAINER_ID}:/artifact.tar.gz ./artifact.tar.gz || exit 1
          docker cp ${CONTAINER_ID}:/metadata.json ./metadata.json || exit 1
          docker rm ${CONTAINER_ID}
          
          # Extract files
          mkdir -p deploy
          tar -xzf artifact.tar.gz -C deploy/ || exit 1
          
          echo "âœ… Artifact extracted"
          cat metadata.json
      
      # ========================================================================
      # Deploy to AWS
      # ========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Deploy to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          echo "â˜ï¸ Deploying to S3: ${S3_BUCKET}"
          
          # Deploy immutable assets with long cache
          aws s3 sync deploy/ s3://${S3_BUCKET}/ \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "config/*" \
            --exclude "*/remoteEntry.json"
          
          # Deploy index.html with no-cache
          if [ -f "deploy/index.html" ]; then
            aws s3 cp deploy/index.html s3://${S3_BUCKET}/index.html \
              --cache-control "no-cache,no-store,must-revalidate"
          fi
          
          # Deploy runtime configs with no-cache
          if [ -d "deploy/config" ]; then
            aws s3 sync deploy/config/ s3://${S3_BUCKET}/config/ \
              --cache-control "no-cache,no-store,must-revalidate"
          fi
          
          # Deploy MFE entry points with no-cache
          if [ -d "deploy/mfe-bundles" ]; then
            find deploy/mfe-bundles -name "remoteEntry.json" | while read file; do
              s3_path="${file#deploy/}"
              aws s3 cp "$file" "s3://${S3_BUCKET}/${s3_path}" \
                --cache-control "no-cache,no-store,must-revalidate"
            done
          fi
          
          echo "âœ… Deployed to S3"
      
      - name: Invalidate CloudFront
        env:
          DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          echo "ðŸ”„ Invalidating CloudFront..."
          
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${DISTRIBUTION_ID} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "âœ… Invalidation created: ${INVALIDATION_ID}"
          
          # Wait for completion (with timeout)
          timeout 300 aws cloudfront wait invalidation-completed \
            --distribution-id ${DISTRIBUTION_ID} \
            --id ${INVALIDATION_ID} || echo "âš ï¸ Invalidation still in progress"
      
      # ========================================================================
      # Validate Deployment
      # ========================================================================
      - name: Smoke test
        env:
          CLOUDFRONT_URL: ${{ secrets.CLOUDFRONT_URL }}
        run: |
          echo "ðŸ§ª Running smoke test..."
          
          # Wait for CloudFront to propagate
          sleep 10
          
          # Test HTTP 200
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${CLOUDFRONT_URL})
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Smoke test failed: HTTP ${HTTP_STATUS}"
            exit 1
          fi
          
          echo "âœ… Smoke test passed"
      
      # ========================================================================
      # Summary
      # ========================================================================
      - name: Deployment summary
        if: always()
        env:
          APP_NAME: ${{ steps.vars.outputs.app_name }}
          BUILD_VERSION: ${{ steps.vars.outputs.build_version }}
          ENVIRONMENT: ${{ steps.vars.outputs.environment }}
          SOURCE: ${{ steps.vars.outputs.source }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="âœ… SUCCESS"
          else
            STATUS="âŒ FAILED"
          fi
          
          echo "### ${STATUS} - Deployment to ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** ${APP_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${BUILD_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${SOURCE}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront:** ${{ secrets.CLOUDFRONT_URL }}" >> $GITHUB_STEP_SUMMARY

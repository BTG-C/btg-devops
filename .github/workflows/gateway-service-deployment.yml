name: Gateway Service Deployment

on:
  repository_dispatch:
    types: [deploy-gateway-service]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Docker image tag'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Gateway Service
    runs-on: ubuntu-latest
    environment: ${{ github.event.client_payload.environment || inputs.environment }}
    
    steps:
      - name: Checkout DevOps repo
        uses: actions/checkout@v4
      
      - name: Set variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "IMAGE_TAG=${{ github.event.client_payload.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ github.event.client_payload.environment }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ inputs.environment }}" >> $GITHUB_ENV
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Prepare task definition
        run: |
          cp services/gateway-service/ecs/task-definition-template.json task-def.json
          
          # Replace placeholders
          sed -i "s/{{ENVIRONMENT}}/${{ env.ENV_NAME }}/g" task-def.json
          sed -i "s|{{IMAGE_TAG}}|$IMAGE_TAG|g" task-def.json
          sed -i "s/{{AWS_ACCOUNT_ID}}/${{ secrets.AWS_ACCOUNT_ID }}/g" task-def.json
          sed -i "s/{{AWS_REGION}}/${{ secrets.AWS_REGION }}/g" task-def.json
          
          # Inject environment variables from config
          CONFIG_FILE="services/gateway-service/config/${{ env.ENV_NAME }}.json"
          CONFIG_ENV=$(jq -r '.envVars | to_entries | map({name: .key, value: .value})' $CONFIG_FILE)
          jq --argjson env "$CONFIG_ENV" '.containerDefinitions[0].environment = $env' task-def.json > task-def-updated.json
          mv task-def-updated.json task-def.json
          
      - name: Deploy to ECS
        run: |
          echo "ðŸš€ Deploying to ECS Cluster: btg-${{ env.ENV_NAME }}-cluster"
          echo "Service: btg-${{ env.ENV_NAME }}-gateway-service"
          echo "Image: ghcr.io/btg-c/btg-gateway-service:$IMAGE_TAG"
          
          # Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
            
          echo "âœ… Registered Task Definition: $NEW_TASK_DEF_ARN"
          
          # Update Service
          aws ecs update-service \
            --cluster btg-${{ env.ENV_NAME }}-cluster \
            --service btg-${{ env.ENV_NAME }}-gateway-service \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment
            
          echo "â³ Waiting for deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster btg-${{ env.ENV_NAME }}-cluster \
            --services btg-${{ env.ENV_NAME }}-gateway-service
            
          echo "âœ… Deployment Successful!"
      
      - name: Smoke test
        run: |
          echo "Running smoke test..."
          HEALTH_URL="${{ secrets.GATEWAY_ALB_URL }}/actuator/health"
          
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Smoke test passed (HTTP $HTTP_STATUS)"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS failed (HTTP $HTTP_STATUS), retrying in 10s..."
            sleep 10
          done
          
          echo "âŒ Smoke test failed after $MAX_ATTEMPTS attempts"
          exit 1
      
      - name: Deployment summary
        if: always()
        run: |
          ENV_NAME="${{ github.event.inputs.environment || github.event.client_payload.environment }}"
          
          echo "## Gateway Service Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster:** btg-$ENV_NAME-cluster" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** btg-$ENV_NAME-gateway-service" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

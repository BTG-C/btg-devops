# ==============================================================================
# Gateway Service Deployment Pipeline
# ==============================================================================
# Runs in: btg-devops repository
# Purpose: Deploy Gateway Service Docker image to AWS ECS
#
# ------------------------------------------------------------------------------
# ðŸ” CRITICAL SECRETS SETUP
# ------------------------------------------------------------------------------
# The following secrets must be added to THIS repository:
#
# 1. AWS Credentials:
#    - AWS_ACCESS_KEY_ID
#    - AWS_SECRET_ACCESS_KEY
#    - AWS_REGION (e.g., us-east-1)
#    - AWS_ACCOUNT_ID
#
# 2. ECS Infrastructure:
#    - GATEWAY_CLUSTER: Name of the ECS Cluster
#    - GATEWAY_SERVICE: Name of the ECS Service
# ==============================================================================

name: Gateway Service Deployment

on:
  repository_dispatch:
    types: [deploy-gateway-service]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Docker image tag'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy Gateway Service
    runs-on: ubuntu-latest
    environment: ${{ github.event.client_payload.environment || inputs.environment }}
    
    steps:
      - name: Checkout DevOps repo
        uses: actions/checkout@v4
      
      - name: Set variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "IMAGE_TAG=${{ github.event.client_payload.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ github.event.client_payload.environment }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV
            echo "ENV_NAME=${{ inputs.environment }}" >> $GITHUB_ENV
          fi
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Deploy to ECS
        run: |
          echo "ðŸš€ Deploying to ECS Cluster: ${{ secrets.GATEWAY_CLUSTER }}"
          echo "Service: ${{ secrets.GATEWAY_SERVICE }}"
          echo "Image: ghcr.io/btg-c/btg-gateway-service:$IMAGE_TAG"
          
          # 1. Fetch current task definition
          # Allows us to preserve environment variables/secrets set in AWS console
          aws ecs describe-task-definition \
            --task-definition ${{ secrets.GATEWAY_SERVICE }} \
            --query taskDefinition > task-def.json
          
          # 2. Update image in container definitions using jq
          # Cleans up read-only fields to make it valid for registration
          jq --arg IMAGE "ghcr.io/btg-c/btg-gateway-service:$IMAGE_TAG" \
             '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' \
             task-def.json > new-task-def.json
             
          # 3. Register new task definition
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
            
          echo "âœ… Registered Task Definition: $NEW_TASK_DEF_ARN"
          
          # 4. Update Service
          aws ecs update-service \
            --cluster ${{ secrets.GATEWAY_CLUSTER }} \
            --service ${{ secrets.GATEWAY_SERVICE }} \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment
            
          echo "â³ Waiting for deployment to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ secrets.GATEWAY_CLUSTER }} \
            --services ${{ secrets.GATEWAY_SERVICE }}
            
          echo "âœ… Deployment Successful!"

            --output text)
          
          if [ -z "$TASK_ARNS" ]; then
            echo "No running tasks found"
            exit 1
          fi
          
          TASK_HEALTH=$(aws ecs describe-tasks \
            --cluster ${{ secrets.GATEWAY_CLUSTER }} \
            --tasks $TASK_ARNS \
            --query 'tasks[0].healthStatus' \
            --output text)
          
          echo "Task health status: $TASK_HEALTH"
          
          if [ "$TASK_HEALTH" != "HEALTHY" ]; then
            echo "Task is not healthy"
            exit 1
          fi
      
      - name: Smoke test
        run: |
          echo "Running smoke test..."
          HEALTH_URL="${{ secrets.GATEWAY_ALB_URL }}/actuator/health"
          
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Smoke test passed (HTTP $HTTP_STATUS)"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS failed (HTTP $HTTP_STATUS), retrying in 10s..."
            sleep 10
          done
          
          echo "âŒ Smoke test failed after $MAX_ATTEMPTS attempts"
          exit 1
      
      - name: Deployment summary
        if: always()
        run: |
          ENV_NAME="${{ github.event.inputs.environment || github.event.client_payload.environment }}"
          
          echo "## Gateway Service Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Task Definition:** ${{ steps.task-def.outputs.task_definition_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster:** ${{ secrets.GATEWAY_CLUSTER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ secrets.GATEWAY_SERVICE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
